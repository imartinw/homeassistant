#
# alarm_clock.yaml
#
# Source: https://community.home-assistant.io/t/alarm-clock-with-sonos-philips-hue/23421
#

sensor:
  - platform: template
    sensors:
      alarm_clock_time:
        friendly_name: 'Alarm Time'
        icon_template: 'mdi:alarm'
        value_template: '{{ "%0.02d:%0.02d" | format(states.input_number.alarm_clock_hour.state | int, states.input_number.alarm_clock_minute.state | int ) }}'
      alarm_clock_fade_in_minutes:
        friendly_name: 'Fade In (Minutes)'
        icon_template: 'mdi:gradient'
        value_template: '{{ states.input_number.alarm_clock_fade_in_minutes.state | int }}'

input_boolean:
  alarm_clock_status:
    name: Alarm Set
    icon: mdi:alarm-check
#    initial: off
  alarm_clock_weekday:
    name: Weekdays Only 
    icon: mdi:calendar
    initial: on
input_number:
  alarm_clock_hour:
    name: Hour
    icon: mdi:timer
    initial: 7
    min: 0
    max: 23
    step: 1
  alarm_clock_minute:
    name: Minute
    icon: mdi:timer
    initial: 0
    min: 0
    max: 55
    step: 5
  alarm_clock_fade_in_minutes:
    name: Fade In (Minutes)
    icon: mdi:gradient
    initial: 30
    min: 0
    max: 30
    step: 5

automation:
  - id: '9566736723723'
    alias: Alarm Clock - Hue
    trigger:
    - platform: time_pattern
      seconds: '0'
    condition:
    - condition: and
      conditions:
      - condition: state
        entity_id: input_boolean.alarm_clock_status
        state: 'on'
      - condition: state
        entity_id: group.all_persons
        state: home
      - condition: template
        value_template: '{{ (utcnow().strftime("%s") | int + states.sensor.alarm_clock_fade_in_minutes.state
          | int * 60) | timestamp_custom("%H:%M") == states.sensor.alarm_clock_time.state
          }}'
      - condition: or
        conditions:
        - condition: state
          entity_id: input_boolean.alarm_clock_weekday
          state: 'off'
        - condition: time
          weekday:
          - mon
          - tue
          - wed
          - thu
          - fri
    action:
    - service: script.alarm_clock_fade_in_light
 
  - id: '8852934929626'
    alias: Alarm Clock - Sonos
    trigger:
    - platform: time_pattern
      seconds: '0'
    condition:
    - condition: and
      conditions:
      - condition: state
        entity_id: input_boolean.alarm_clock_status
        state: 'on'
      - condition: state
        entity_id: group.all_persons
        state: home
      - condition: template
        value_template: '{{ (utcnow().strftime("%s") | int) | timestamp_custom("%H:%M")
          == states.sensor.alarm_clock_time.state }}'
      - condition: or
        conditions:
        - condition: state
          entity_id: input_boolean.alarm_clock_weekday
          state: 'off'
        - condition: time
          weekday:
          - mon
          - tue
          - wed
          - thu
          - fri
    action:
    - service: script.alarm_clock_play_sound

group:
  alarm_clock:
    name: Alarm Clock
    entities:
      - input_boolean.alarm_clock_status
      - sensor.alarm_clock_time
      - input_number.alarm_clock_hour
      - input_number.alarm_clock_minute
      - input_number.alarm_clock_fade_in_minutes

# end of file
